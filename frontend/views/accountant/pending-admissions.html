<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Admissions - Accountant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
        .dashboard { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 2rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; }
        .sidebar-menu { padding: 1.5rem; }
        .sidebar-item { display: block; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; color: #374151; text-decoration: none; }
        .sidebar-item:hover { background: #d1fae5; color: #10b981; }
        .sidebar-item.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .main-content { margin-left: 260px; flex: 1; padding: 2rem; }
        
        .filters-container { background: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; font-size: 0.875rem; }
        .filter-group input, .filter-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #10b981; }
        .filter-btn { padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .filter-btn:hover { background: #059669; }
        .reset-btn { padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .reset-btn:hover { background: #4b5563; }
        
        .table-container { background: white; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table thead { background: #f9fafb; }
        .table th { padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem; border-bottom: 2px solid #e5e7eb; cursor: pointer; user-select: none; }
        .table th:hover { background: #f3f4f6; }
        .table th.sortable::after { content: ' ‚Üï'; color: #9ca3af; }
        .table th.sorted-asc::after { content: ' ‚Üë'; color: #10b981; }
        .table th.sorted-desc::after { content: ' ‚Üì'; color: #10b981; }
        .table td { padding: 1rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; }
        .table tbody tr:hover { background: #f9fafb; }
        
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-jhs { background: #dbeafe; color: #1e40af; }
        .badge-shs { background: #e0e7ff; color: #5b21b6; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-processed { background: #d1fae5; color: #065f46; }
        
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; font-weight: 500; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
        .btn-primary { background: #10b981; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .stat-card .number { font-size: 2rem; font-weight: 700; color: #10b981; }
        
        .loading { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .hidden { display: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; display: none; }
        .modal { background: white; max-width: 600px; margin: 2rem auto; border-radius: 1rem; box-shadow: 0 20px 25px rgba(0,0,0,0.15); }
        .modal-header { padding: 2rem; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 1.5rem; color: #1f2937; }
        .modal-body { padding: 2rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 1rem; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #10b981; }
        
        .student-info { background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .student-info p { margin-bottom: 0.5rem; color: #374151; }
    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üí∞ Enrollment System</h2>
                <p>Accountant Portal</p>
            </div>
            <nav class="sidebar-menu">
                <a href="/views/accountant/dashboard.html" class="sidebar-item">üìä Dashboard</a>
                <a href="/views/accountant/pending-admissions.html" class="sidebar-item active">üìù Pending Admissions</a>
                <a href="/views/accountant/payment-schemes.html" class="sidebar-item">üí≥ Payment Schemes</a>
            </nav>
        </aside>

        <main class="main-content">
            <div style="margin-bottom: 2rem;">
                <h1 style="font-size: 2rem; color: #1f2937;">Pending Admissions</h1>
                <p style="color: #6b7280;">Assign payment schemes to approved applications</p>
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Pending</h3>
                    <div class="number" id="totalPending">0</div>
                </div>
                <div class="stat-card">
                    <h3>Payment Assigned</h3>
                    <div class="number" id="totalAssigned">0</div>
                </div>
                <div class="stat-card">
                    <h3>Pending Assignment</h3>
                    <div class="number" id="totalUnassigned">0</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="filter-group">
                    <label>Search by Name or ID</label>
                    <input type="text" id="searchInput" placeholder="Enter name or ID...">
                </div>
                <div class="filter-group">
                    <label>School Level</label>
                    <select id="levelFilter">
                        <option value="">All Levels</option>
                        <option value="JHS">JHS</option>
                        <option value="SHS">SHS</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Grade</label>
                    <select id="gradeFilter">
                        <option value="">All Grades</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="assigned">Assigned</option>
                    </select>
                </div>
                <button class="filter-btn" onclick="applyFilters()">Filter</button>
                <button class="reset-btn" onclick="resetFilters()">Reset</button>
            </div>

            <div class="table-container">
                <div id="loading" class="loading">Loading applications...</div>
                <div id="emptyState" class="empty-state hidden">No applications found</div>
                <table class="table" id="applicationsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('application_id')">ID</th>
                            <th class="sortable" onclick="sortTable('name')">Name</th>
                            <th class="sortable" onclick="sortTable('school_level')">Level</th>
                            <th class="sortable" onclick="sortTable('grade_level')">Grade</th>
                            <th class="sortable" onclick="sortTable('reviewed_at')">Approved Date</th>
                            <th class="sortable" onclick="sortTable('status')">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Payment Assignment Modal -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Assign Payment Scheme</h2>
            </div>
            <div class="modal-body">
                <div class="student-info" id="studentInfo"></div>

                <form id="paymentForm">
                    <input type="hidden" id="applicationId">
                    
                    <div class="form-group">
                        <label>Payment Scheme <span style="color: red;">*</span></label>
                        <select id="schemeId" required>
                            <option value="">Select payment scheme...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Total Amount <span style="color: red;">*</span></label>
                        <input type="number" id="totalAmount" step="0.01" required readonly style="background: #f9fafb;">
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <input type="text" id="notes" placeholder="Additional notes...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="submitPayment()" class="btn btn-primary">Assign Payment</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/views/public/login.html';

        let paymentSchemes = [];
        let currentApplication = null;
        let allApplications = [];
        let currentSort = { field: null, order: 'asc' };

        async function loadApplications() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('applicationsTable').style.display = 'none';

            try {
                const response = await fetch('http://localhost:3000/api/payments/applications', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';

                if (response.ok && data.success) {
                    allApplications = data.applications;
                    updateStats();
                    displayApplications(allApplications);
                } else {
                    alert('Failed to load applications');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Connection error');
            }
        }

        function updateStats() {
            const total = allApplications.length;
            const assigned = allApplications.filter(a => a.payment_record_id !== null).length;
            const unassigned = total - assigned;

            document.getElementById('totalPending').textContent = total;
            document.getElementById('totalAssigned').textContent = assigned;
            document.getElementById('totalUnassigned').textContent = unassigned;
        }

        function displayApplications(applications) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (applications.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('applicationsTable').style.display = 'none';
                return;
            }

            applications.forEach(app => {
                const row = document.createElement('tr');
                const date = new Date(app.reviewed_at).toLocaleDateString();
                const hasPayment = app.payment_record_id !== null;
                
                row.innerHTML = `
                    <td>#${app.application_id}</td>
                    <td><strong>${app.first_name} ${app.last_name}</strong></td>
                    <td><span class="badge badge-${app.school_level.toLowerCase()}">${app.school_level}</span></td>
                    <td>Grade ${app.grade_level}</td>
                    <td>${date}</td>
                    <td>
                        ${hasPayment ? 
                            '<span class="badge badge-processed">‚úì Assigned</span>' : 
                            '<span class="badge badge-pending">‚è≥ Pending</span>'
                        }
                    </td>
                    <td>
                        ${!hasPayment ? 
                            `<button onclick="openPaymentModal(${app.application_id})" class="btn btn-primary btn-sm">Assign</button>` :
                            `<span style="color: #10b981;">‚úì Completed</span>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('applicationsTable').style.display = 'table';
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const grade = document.getElementById('gradeFilter').value;
            const status = document.getElementById('statusFilter').value;

            let filtered = allApplications.filter(app => {
                const matchSearch = !search || 
                    app.first_name.toLowerCase().includes(search) ||
                    app.last_name.toLowerCase().includes(search) ||
                    app.application_id.toString().includes(search);

                const matchLevel = !level || app.school_level === level;
                const matchGrade = !grade || app.grade_level.toString() === grade;
                const matchStatus = !status || 
                    (status === 'pending' && app.payment_record_id === null) ||
                    (status === 'assigned' && app.payment_record_id !== null);

                return matchSearch && matchLevel && matchGrade && matchStatus;
            });

            displayApplications(filtered);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('gradeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            displayApplications(allApplications);
        }

        function sortTable(field) {
            const ths = document.querySelectorAll('.table th.sortable');
            ths.forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));

            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }

            const event = event || {};
            event.target?.classList.add(`sorted-${currentSort.order}`);

            let sorted = [...allApplications];
            sorted.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'name') {
                    aVal = `${a.first_name} ${a.last_name}`;
                    bVal = `${b.first_name} ${b.last_name}`;
                }

                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return currentSort.order === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            displayApplications(sorted);
        }

        async function loadPaymentSchemes() {
            try {
                const response = await fetch('http://localhost:3000/api/payments/schemes', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    paymentSchemes = data.schemes;
                }
            } catch (error) {
                console.error('Failed to load schemes:', error);
            }
        }

        async function openPaymentModal(applicationId) {
            currentApplication = applicationId;

            try {
                const response = await fetch(`http://localhost:3000/api/admission/${applicationId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const app = data.application;

                    document.getElementById('studentInfo').innerHTML = `
                        <p><strong>Name:</strong> ${app.first_name} ${app.last_name}</p>
                        <p><strong>School Level:</strong> ${app.school_level} - Grade ${app.grade_level}</p>
                        <p><strong>Application Type:</strong> ${app.application_type}</p>
                    `;

                    const select = document.getElementById('schemeId');
                    select.innerHTML = '<option value="">Select payment scheme...</option>';
                    
                    const relevantSchemes = paymentSchemes.filter(s => 
                        s.school_level === app.school_level && 
                        s.grade_level === app.grade_level.toString()
                    );

                    relevantSchemes.forEach(scheme => {
                        const option = document.createElement('option');
                        option.value = scheme.scheme_id;
                        option.textContent = `${scheme.scheme_name} - ‚Ç±${parseFloat(scheme.total_amount).toLocaleString()}`;
                        option.dataset.amount = scheme.total_amount;
                        select.appendChild(option);
                    });

                    document.getElementById('applicationId').value = applicationId;
                    document.getElementById('paymentModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load application details');
            }
        }

        document.getElementById('schemeId').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.amount) {
                document.getElementById('totalAmount').value = parseFloat(selectedOption.dataset.amount).toFixed(2);
            } else {
                document.getElementById('totalAmount').value = '';
            }
        });

        async function submitPayment() {
            const applicationId = document.getElementById('applicationId').value;
            const schemeId = document.getElementById('schemeId').value;
            const totalAmount = document.getElementById('totalAmount').value;
            const notes = document.getElementById('notes').value;

            if (!schemeId || !totalAmount) {
                alert('Please select a payment scheme');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/payments/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        applicationId,
                        schemeId,
                        totalAmount,
                        notes
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Payment record created successfully!');
                    closeModal();
                    loadApplications();
                } else {
                    alert(data.message || 'Failed to create payment record');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Connection error');
            }
        }

        function closeModal() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
        }

        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Keyboard shortcut: Escape to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('paymentModal').style.display === 'block') {
                closeModal();
            }
        });

        // Load data on page load
        loadPaymentSchemes().then(() => {
            loadApplications();
        });
    </script>
</body>
</html>
